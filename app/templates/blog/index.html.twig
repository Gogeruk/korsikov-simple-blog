{% extends 'base.html.twig' %}

{% block title %}
    {% if title %}
        {{ title }}
    {% else %}
        Topics
    {% endif %}
{% endblock %}

{% block body %}
    {% if title %}
        <h1>{{ title }}</h1>
        <div>{{ content|raw }}</div>
    {% else %}
        <h1>Topics</h1>
        <div>
            <h2>Filter by Tag</h2>
            <ul id="tag-list">
                <li><a href="#" data-tag="">all</a></li>
                {% for tag in all_tags %}
                    <li><a href="#" data-tag="{{ tag }}">{{ tag }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div>
            <h2>Posts</h2>
            <ul id="post-list">
                {% for post in posts %}
                    <li>
                        <a href="{{ path('blog_post', {slug: post.slug}) }}">{{ post.title }}</a>
                        <small>Tags: {{ post.tags|join(', ') }}</small>
                    </li>
                {% else %}
                    <li>No posts found.</li>
                {% endfor %}
            </ul>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const tagList = document.getElementById('tag-list');
                const postList = document.getElementById('post-list');

                tagList.addEventListener('click', function (event) {
                    if (event.target.tagName === 'A') {
                        event.preventDefault();
                        const tag = event.target.getAttribute('data-tag');
                        fetchPosts(tag);
                    }
                });

                function fetchPosts(tag) {
                    const url = new URL('{{ path('api_v1_blog_list') }}', window.location.origin);
                    if (tag) {
                        url.searchParams.append('tag', tag);
                    }

                    fetch(url.toString())
                        .then(response => response.json())
                        .then(posts => {
                            postList.innerHTML = '';
                            if (posts.length === 0) {
                                postList.innerHTML = '<li>No posts found.</li>';
                                return;
                            }

                            posts.forEach(post => {
                                post.slug = post.slug.replace(/^blog\//, '');
                                post.tags = post.tags.map(tag => tag.name);

                                const postElement = document.createElement('li');
                                postElement.innerHTML = `
                                    <a href="/blog/${post.slug}">${post.title}</a>
                                    <small>Tags: ${post.tags.join(', ')}</small>
                                `;
                                postList.appendChild(postElement);
                            });
                        });
                }
            });
        </script>
    {% endif %}
{% endblock %}